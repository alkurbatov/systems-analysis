# Описание системы

## Глоссарий
* КК - коты-тестировщики (клиенты), сотрудники компании.
* КМ - коты-менеджеры, сотрудники компании.
* КВ - коты-воркеры.
* КС - коты, работающие на кладе и отвечающие за выдачу расходников, сотрудники компании.
* ук - условные котоединицы.

## Основные компоненты системы
Система состоит из общих частей (блоки белого цвета) и частей специфичных для рабочего процесса конкретных котов (блоки других цветов). Мы делаем выбор в пользу архитектуры из сервисов разного размера для удобства масштабирования, так как разные части системы нагружены по-разному и ожидается, что нагрузка со стороны КВ будет достаточно серьезной.

* Дашборд КК - так как сценарии использования очень разные, КК необходимо отдельное веб-приложение (дашборд), дизайн интерфейса которого должен быть заточен под решаемые КК задачи. Позволяет оставлять заказы, смотреть список активных заказов и статистику (`US-250`).
* Панель управления КМ - так как сценарии использования очень разные, КМ необходимо отдельное веб-приложение (панель) для выполнения задач администрирования системы. Дизайн интерфейса панели должен быть заточен под решаемые КМ задачи.
* Личный кабинет КВ - мобильное приложение для реализации сценариев КВ, позволяет самостоятельно регистрироваться, проходить тестирование (`US-080`), видеть список активных услуг (`US-140`) и статистику (`US-250`). Выбор мобильного приложения вызван необходимость делать фотографии во время выезда на заказ и подтвержать выполнение. С мобильным приложением будет удобнее и быстрее, чем с сайтом/дашбордом.
* Дашборд комплектации - минимальный веб интерфейс, содержащий список заказов для выдачи комплектующих. Используется КС.
* Веб сервер - любой вебсервер на усмотрение разработчика (например, `Nginx`).
* Rate limiter - ограничения потока запросов от одних и тех же `IP` адрессов для борьбы с `DDoS` атаками со стороны конкурентов (`US-081`).
* Load balancer - балансирует нагрузку на часть систему, отвечающую за работу с КВ (`US-081`). Необходим для обеспечения масштабирования и балансировки запросов.
* БД - SQL база данных на усмотрение разработчика (например, `Postgres`).
* Сервис управления заказами - обслуживает запросы от КК и КМ, использует ролевую модель, позволяющую ограничить список доступных операций в зависимости от роли. Сервис также осуществляет управление жизненным циклом заказа КК и системой ставок.
* Сервис оплаты - необходим для интеграции с различными платежными системами, выполняет платежные поручения и инкапсулирует особенности взаимодействия с различными системами платежей.
* Сервис матчинга - выполняет матчинг заказов и КВ, реализуется отдельной командой на языке по их выбору (`US-070`). Для нашей системы представляет собой черный ящик.
* Сервис статистики - отвечает за выполнение запросов на получение статистики, предоставляет информацию о КВ и истории заказов (`US-071`) другим сервисам. Статистика хранится в БД.
* Сервис КВ - используется КВ для регистрации, оставления заявок на тестирование, получения данных об актуальных услугах. Этот функционал предполагает большую нагрузку, поэтому для удобства масштабирования вынесен в отдельный сервис.
* Сервис нотификаций - общий сервис для всех внутренних компонентов системы, инкапсулюрующий логику работы по отправке почтовых нотификаций (писем). Позволяет отправлять нотификации по почте из любого сервиса (`US-300`).

## Взаимодействия компонентов
1. Для взаимодействия с веб панелями выбран протокол `HTTP` в силу простоты интеграции фронтенда и бэкенда.
2. Для внутреннего взаимодействия между сервиса выбран протокол `gRPC`, позволяющий обеспечить высокую скорость обмена данными внутри системы.

## Ограничения первой версии продукта
* В связи с тем, что мы доверяем нашим сотрудникам, а панели КК и КМ будут доступны только из внутренней сети компании, веб сервер не нужно снабжать защитой от `DDoS` атак.
* Стоимость всех заказов равна 100 ук (`US-050`).
* Отмена заказа не изменяет итоговую величину суммы списания с КК.

## Рабочие процессы
### Флоу подготовки системы к работе
1. КМ самостоятельно регистрируются (при необходимости) и аутентифицируются в дашборде.
2. КМ создают или редактируют список доступных услуг (`US-021`). Список доступных услуг доступен через сервис управления заказами и хранится в БД.
3. КМ вместе с разработчиками сервиса матчинга настраивают шаги алгоритма матчинга через файл конфигурации сервиса матчинга (`US-070`).
4. КМ настраивают тесты для КВ через панель управления (`US-110`).

### Флоу тестирования КВ
1. КВ регистрируется и аутентифицируется в личном кабинете КВ (`US-090`) и оставляет заявку на тестирование (`US-090`).
2. КМ связывается с КВ и назначает тестирование.
3. КМ конфигурирует набор тестов или назначает один из готовых (`US-110`) через личный кабинет КВ и сервис КВ. Общие и персональные тесты хранятся в БД.
4. КВ получает свой набор тестов через личный кабинет КВ и сервис КВ.
5. КМ сохраняют результаты прохождения тестов в БД через панель управления КМ и сервис КВ (`US-120`). Результаты доступны через сервис статистики.
6. В случае успешного прохождения теста, КМ добавляет КВ в пул доступных КВ.
7. Сервис КВ отправляет КВ почтовую нотификацию, содержащую результаты и ссылку с описанием дальнейших действий (`US-301`).
8. Сервис КВ регистрирует периодическую задачу на сервисе оплаты для осуществления периодических выплат КВ (`US-230`).

### Флоу заказа услуги
1. КК самостоятельно регистрируются (при необходимости) и аутентифицируются в дашборде (`US-010`).
2. КК размещают заказы через интерфейс дашборда (`US-020`, `US-030`) и могут отменить заказ при необходимости.
3. КК создает заказ в сервисе управления заказов. Все созданные заказы и их текущее состояние хранится в БД.
4. Сервис управления заказами обращается к сервису матчинга для подбора исполнителя.
5. Сервис матчинга запрашивает статистику необходимую для корректной работы алгоритма из сервиса статистистики.
6. Сервис матчинга подбирает идеального исполнителя (`US-072`) и отправляет результаты работы в сервис управления заказами.
7. Сервис управления заказами рассчитывает итоговую стоимость каждого заказа (`US-050`).
8. Сервис управления заказами отправляет детали об оплате в сервис оплаты. Результаты также сохраняются в БД.
9. Сервис управления заказами рассчитывает значение скидки и сохраняет его в БД (`US-040`). Значение скидки должно быть доступно для просмотра КК и КМ в их панелях.
10. В процессе оформления и оплаты заказа сервис управления заказов отправляет нотификации всем участникам процесса через сервис нотификаций (`US-302`, `US-304`, `US-306`), а также уведомляет подрядчика о необходимости доставки печенья (`US-170`).

### Флоу выполнения услуги
1. КВ получает письмо о новом заказе (`US-306`).
2. КВ видит список доступных заказов в личном кабинете КВ (`US-140`), список формируется сервисом КВ на основе данных, хранящихся в БД.
3. Если КВ не пришел на заказ или долгое время не приступал к выполнению, заказ отменяется и КК может повторить его (`US-130`).
4. КВ нажимает кнопку "Принять заказ" в личном кабинете.
5. Сервис КВ отправляет нотификацию сотрудникам отдела расходников (`US-150`).
6. КС в дашборде комплектации видят информацию о новой заявке и начинают собирать заказ.
7. КВ получает расходники, после чего КС отмечает в дашборде что расходники выданы (`US-160`).
8. КВ приступает к выполнению заказа, отмечая в приложении "Приступил".
9. Сервис КВ отправляет нотификацию о начале работы над заказом (`US-180`) и изменяет статус заказа в БД.
10. КВ выполняет заказ.
11. После выполнения заказа КВ отправляет отчетные документы через мобильное приложение.
12. Сервис КВ отправляет нотификацию (`US-180`) и изменяет статус заказа в БД. Все отчетные документы, время выполнения заказа и прочие связанные данные сохраняются в сервисе статистики.
13. Если заказ считается проваленным, сервис КВ отправляет дополнительную нотификацию КМ для начала проверки (`US-200`), а также начисляет штрафные баллы (`US-240`). Вся информация сохраняется в БД.

### Флоу проверки заказа
1. КМ выбирает заказ из списка выполненных, полученных через сервис управления заказами (`US-190`).
2. Результаты проверки качества сохраняются в БД через сервис управления заказами (`US-210`).

### Флоу оплаты КК
1. Списание средств с КК осуществляется сервисом управления заказами каждое воскресенье.
2. Cервис управления заказами отправляет команду на оплату в сервис оплаты, результаты списания сохраняются в БД (`US-220`).

### Флоу оплаты КВ
1. Оплата услуг КВ осуществляется каждый последний день месяца сервисом КВ.
2. Сервис КВ рассчитывает итоговую сумму оплаты с учетом накопленных штрафных баллов (`US-240`).
3. Сервис КВ отправляет команду на оплату в сервис оплаты, результаты сохраняются в БД (`US-230`).

### Премирование КВ
1. КМ может премировать КВ, совершив соответствующую операцию через панель управления КМ и сервис КВ.
2. Сервис КИ отправляет заявку на оплату в сервис оплаты. Все результаты сохраняются в БД (`US-270`).

### Ставки
1. КМ может поставить деньги через панель управления КМ на конкретный заказ (`US-280`).
2. По результатам изменения статуса заказа (выполнен или провален) сервис управления заказами отправляет нотификацию всем поставившим КМ.
3. Сервис управления заказами выполняет списание средств через сервис оплаты с проигравших КМ (`US-290`).
4. Сервис управления заказами выполняет начисление средств через сервис оплаты выигравшим КМ (`US-290`).